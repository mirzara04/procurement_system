<% content_for :title, 'Purchase Orders' %>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">Purchase Orders</h5>
    <% if policy(PurchaseOrder.new).create? %>
      <%= link_to new_purchase_order_path, class: 'btn btn-primary', title: 'Create new purchase order' do %>
        <i class="bi bi-plus-circle"></i> New Purchase Order
      <% end %>
    <% end %>
  </div>

  <div class="card-body">
    <%= search_form_for @q, class: 'mb-4' do |f| %>
      <div class="row g-3">
        <div class="col-md-2">
          <%= f.label :po_number_cont, 'PO Number', class: 'form-label' %>
          <%= f.search_field :po_number_cont, class: 'form-control', placeholder: 'Search PO number' %>
        </div>
        <div class="col-md-3">
          <%= f.label :vendor_name_cont, 'Vendor', class: 'form-label' %>
          <%= f.search_field :vendor_name_cont, class: 'form-control', placeholder: 'Search vendor name' %>
        </div>
        <div class="col-md-2">
          <%= f.label :vendor_status_eq, 'Vendor Status', class: 'form-label' %>
          <%= f.select :vendor_status_eq, 
              Vendor.statuses.map { |k, v| [k.titleize, v] },
              { include_blank: 'All Statuses' }, 
              class: 'form-select' %>
        </div>
        <div class="col-md-2">
          <%= f.label :created_at_gteq, 'Date From', class: 'form-label' %>
          <%= f.date_field :created_at_gteq, class: 'form-control' %>
        </div>
        <div class="col-md-2">
          <%= f.label :created_at_lteq, 'Date To', class: 'form-label' %>
          <%= f.date_field :created_at_lteq, class: 'form-control' %>
        </div>
        <div class="col-md-1 d-flex align-items-end">
          <%= button_tag type: 'submit', class: 'btn btn-primary w-100', title: 'Search' do %>
            <i class="bi bi-search"></i>
          <% end %>
        </div>
      </div>
    <% end %>

    <div class="table-responsive">
      <% if @purchase_orders.any? %>
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th><%= sort_link(@q, :po_number, 'PO Number') %></th>
              <th><%= sort_link(@q, 'vendors.name', 'Vendor') %></th>
              <th><%= sort_link(@q, :total_amount, 'Amount') %></th>
              <th><%= sort_link(@q, :status, 'Status') %></th>
              <th><%= sort_link(@q, :expected_delivery_date, 'Expected Delivery') %></th>
              <th><%= sort_link(@q, :created_at, 'Created') %></th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @purchase_orders.each do |po| %>
              <tr>
                <td><%= link_to po.po_number, purchase_order_path(po), title: "View purchase order #{po.po_number}" %></td>
                <td>
                  <%= link_to vendor_path(po.vendor), title: "View vendor details" do %>
                    <%= po.vendor.name %>
                    <span class="badge bg-<%= vendor_status_color(po.vendor.status) %>">
                      <%= po.vendor.status.titleize %>
                    </span>
                  <% end %>
                </td>
                <td><%= number_to_currency(po.total_amount) %></td>
                <td>
                  <span class="badge bg-<%= po_status_color(po.status) %>">
                    <%= po.status.titleize %>
                  </span>
                </td>
                <td><%= po.expected_delivery_date&.strftime("%b %d, %Y") %></td>
                <td><%= po.created_at.strftime("%b %d, %Y") %></td>
                <td>
                  <div class="btn-group">
                    <%= link_to purchase_order_path(po), class: 'btn btn-sm btn-info', title: "View purchase order details" do %>
                      <i class="bi bi-eye"></i>
                    <% end %>
                    
                    <% if policy(po).edit? %>
                      <%= link_to edit_purchase_order_path(po), class: 'btn btn-sm btn-primary', title: "Edit purchase order" do %>
                        <i class="bi bi-pencil"></i>
                      <% end %>
                    <% end %>
                    
                    <% if policy(po).approve? && po.pending_approval? %>
                      <%= button_to approve_purchase_order_path(po),
                          method: :patch,
                          class: 'btn btn-sm btn-success',
                          title: "Approve purchase order",
                          data: { confirm: 'Are you sure you want to approve this purchase order?' } do %>
                        <i class="bi bi-check-lg"></i>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <div class="text-center py-5">
          <i class="bi bi-inbox display-1 text-muted"></i>
          <h4 class="mt-3 text-muted">No Purchase Orders Found</h4>
          <p class="text-muted">
            <% if @q.conditions.any? %>
              No purchase orders match your search criteria. Try adjusting your filters.
            <% else %>
              There are no purchase orders in the system yet.
            <% end %>
          </p>
          <% if policy(PurchaseOrder.new).create? %>
            <%= link_to new_purchase_order_path, class: 'btn btn-primary mt-3' do %>
              <i class="bi bi-plus-circle"></i> Create First Purchase Order
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>

    <% if @purchase_orders.any? %>
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted">
          Showing <%= @purchase_orders.offset_value + 1 %> to 
          <%= @purchase_orders.offset_value + @purchase_orders.length %> of 
          <%= @purchase_orders.total_count %> purchase orders
        </div>
        <%= paginate @purchase_orders, theme: 'bootstrap4' %>
      </div>
    <% end %>
  </div>
</div>

<% content_for :head do %>
  <style>
    .btn-group .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .table td {
      vertical-align: middle;
    }
  </style>
<% end %>

<% content_for :javascript do %>
  <script>
    document.addEventListener('turbo:load', function() {
      // Initialize tooltips
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'))
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
      });

      // Add datepicker if needed
      const dateFields = document.querySelectorAll('input[type="date"]');
      dateFields.forEach(field => {
        // Initialize datepicker if you're using one
      });
    });
  </script>
<% end %> 